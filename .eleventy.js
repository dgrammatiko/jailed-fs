const pluginSyntaxHighlight = require("@11ty/eleventy-plugin-syntaxhighlight");
const eleventyNavigationPlugin = require("@11ty/eleventy-navigation");
// let Nunjucks = require('nunjucks');
const anchor = require("markdown-it-anchor");
// const htmlmin = require("html-minifier");
// const codepenIt = require("11ty-to-codepen");
const Image = require("@11ty/eleventy-img");

async function imageShortcode(src, alt, sizes) {
  let metadata = await Image(src, {
    widths: [300, 600, 1000],
    formats: ["avif", "jpeg"],
    outputDir: "./_site/images/",
    urlPath: "/images/"
  });

  let imageAttributes = {
    alt,
    sizes,
    loading: "lazy",
    decoding: "async",
  };

  // You bet we throw an error on missing alt in `imageAttributes` (alt="" works okay)
  return Image.generateHTML(metadata, imageAttributes);
}

// let nunjucksEnvironment = new Nunjucks.Environment(
//   new Nunjucks.FileSystemLoader('./site/_includes')
// );

module.exports = function (eleventyConfig) {
  let { Liquid } = require('liquidjs');
  let options = {
    extname: ".liquid",
    dynamicPartials: true,
    strictFilters: false, // renamed from `strict_filters` in Eleventy 1.0
    root: ["site/_includes"]
  };

  eleventyConfig.setLibrary("liquid", new Liquid(options));
  // eleventyConfig.setLibrary('njk', nunjucksEnvironment);
  eleventyConfig.setDataDeepMerge(true);
  eleventyConfig.addPassthroughCopy({ "site/images": "images" });
  // eleventyConfig.addPassthroughCopy({ "site/dist": "dist" });
  eleventyConfig.addPassthroughCopy({ "packages": "dist" });

  eleventyConfig.addNunjucksAsyncShortcode("image", imageShortcode);
  eleventyConfig.addLiquidShortcode("image", imageShortcode);
  eleventyConfig.addJavaScriptFunction("image", imageShortcode);
    // eleventyConfig.addPairedShortcode("codepen", codepenIt);
  eleventyConfig.addShortcode("img", function(name, twitterUsername) {
    return `<svg style="width: 100%; height: auto;" width="612.401" height="77.903" viewBox="0 0 612.401 77.903" xmlns="http://www.w3.org/2000/svg"><g id="svgGroup" stroke-linecap="round" fill-rule="evenodd" font-size="9pt" stroke="#fff" stroke-width="0.25mm" fill="none" style="stroke:#fff;stroke-width:0.25mm;fill:none"><path d="M 52.2 76.701 L 39.9 76.701 L 25.7 49.801 L 25.5 49.801 L 10.8 49.801 L 10.8 76.701 L 0 76.701 L 0 7.101 L 24.3 7.101 Q 32.381 7.101 37.912 9.201 A 19.661 19.661 0 0 1 43.6 12.451 A 17.326 17.326 0 0 1 49.494 22.596 A 26.361 26.361 0 0 1 50 27.901 A 27.671 27.671 0 0 1 49.413 33.745 A 20.217 20.217 0 0 1 46.7 40.451 Q 43.4 45.601 36.9 48.001 L 52.2 76.701 Z M 10.8 40.001 L 24.4 40.001 Q 31.3 40.001 34.756 37.521 A 8.817 8.817 0 0 0 35.05 37.301 Q 38.5 34.601 38.5 28.101 Q 38.5 22.001 35.1 19.501 Q 32.005 17.226 25.596 17.021 A 40.708 40.708 0 0 0 24.3 17.001 L 10.8 17.001 L 10.8 40.001 Z" id="0" vector-effect="non-scaling-stroke"/><path d="M 112.5 50.601 L 112.5 54.001 L 75.8 54.001 A 22.095 22.095 0 0 0 76.905 58.897 A 15.418 15.418 0 0 0 80.65 64.851 A 13.522 13.522 0 0 0 87.379 68.376 A 19.866 19.866 0 0 0 91.6 68.801 Q 96.1 68.801 100.8 67.051 A 35.14 35.14 0 0 0 107.961 63.371 A 40.933 40.933 0 0 0 109.9 62.001 L 110.3 62.001 L 110.3 71.701 Q 102 77.901 91.5 77.901 A 32.581 32.581 0 0 1 84.368 77.154 A 25.225 25.225 0 0 1 77.4 74.501 Q 71.4 71.101 68.2 64.851 Q 65 58.601 65 50.401 A 36.106 36.106 0 0 1 65.784 42.72 A 28.823 28.823 0 0 1 67.95 36.351 Q 70.9 30.201 76.4 26.751 A 22.585 22.585 0 0 1 86.038 23.472 A 28.56 28.56 0 0 1 89.2 23.301 A 25.208 25.208 0 0 1 95.669 24.098 A 20.241 20.241 0 0 1 101.65 26.751 A 21.761 21.761 0 0 1 109.058 35.078 A 26.561 26.561 0 0 1 109.7 36.401 Q 112.5 42.601 112.5 50.601 Z M 75.9 46.201 L 101.4 46.201 A 28.165 28.165 0 0 0 100.584 42.001 Q 99.947 39.724 98.94 37.915 A 14.213 14.213 0 0 0 97.55 35.851 A 9.939 9.939 0 0 0 90.332 32.146 A 13.999 13.999 0 0 0 89.2 32.101 A 12.789 12.789 0 0 0 84.635 32.888 A 11.403 11.403 0 0 0 80.2 35.951 A 15.907 15.907 0 0 0 76.996 41.422 Q 76.237 43.567 75.91 46.12 A 27.682 27.682 0 0 0 75.9 46.201 Z" id="1" vector-effect="non-scaling-stroke"/><path d="M 123.7 72.301 L 123.7 61.601 A 46.136 46.136 0 0 0 127.746 64.388 Q 129.943 65.726 132.06 66.62 A 27.265 27.265 0 0 0 132.75 66.901 Q 137.1 68.601 141.9 68.601 A 23.56 23.56 0 0 0 144.873 68.426 Q 146.389 68.232 147.646 67.826 A 10.203 10.203 0 0 0 149.9 66.801 A 6.956 6.956 0 0 0 151.521 65.445 A 5.252 5.252 0 0 0 152.8 61.901 A 6.048 6.048 0 0 0 152.487 59.902 Q 151.889 58.186 150.15 57.201 Q 147.946 55.954 143.634 54.707 A 78.645 78.645 0 0 0 141.8 54.201 A 88.929 88.929 0 0 1 138.261 53.227 Q 136.688 52.756 135.335 52.275 A 39.283 39.283 0 0 1 132.85 51.301 Q 129.4 49.801 126.9 46.801 A 10.247 10.247 0 0 1 124.896 42.827 Q 124.4 40.972 124.4 38.701 A 14.206 14.206 0 0 1 125.54 32.932 Q 126.915 29.798 129.95 27.501 A 19.661 19.661 0 0 1 136.965 24.194 Q 139.76 23.469 143.054 23.333 A 37.497 37.497 0 0 1 144.6 23.301 Q 153.4 23.301 160.7 27.801 L 160.7 38.201 Q 156.7 35.201 153.05 33.901 A 22.763 22.763 0 0 0 146.499 32.633 A 26.341 26.341 0 0 0 145.2 32.601 A 24.932 24.932 0 0 0 142.405 32.748 Q 141.003 32.906 139.841 33.237 A 10.067 10.067 0 0 0 137.7 34.101 A 6.079 6.079 0 0 0 136.247 35.196 A 4.458 4.458 0 0 0 135 38.401 A 4.899 4.899 0 0 0 135.352 40.297 Q 135.837 41.465 136.992 42.245 A 6.031 6.031 0 0 0 137.5 42.551 A 17.802 17.802 0 0 0 139.151 43.323 Q 141.575 44.323 145.6 45.401 Q 151.2 46.901 154.7 48.351 A 14.816 14.816 0 0 1 160.181 52.322 A 17.718 17.718 0 0 1 160.75 53.001 Q 163.087 55.934 163.282 60.631 A 20.97 20.97 0 0 1 163.3 61.501 A 14.734 14.734 0 0 1 162.212 67.2 A 14.022 14.022 0 0 1 160.65 70.001 A 16.599 16.599 0 0 1 155.756 74.494 A 21.147 21.147 0 0 1 153.25 75.801 A 24.418 24.418 0 0 1 146.477 77.653 A 30.936 30.936 0 0 1 142.5 77.901 Q 137.6 77.901 132.75 76.451 Q 127.9 75.001 123.7 72.301 Z" id="2" vector-effect="non-scaling-stroke"/><path d="M 190.8 5.901 L 190.8 24.501 L 204.1 24.501 L 204.1 33.101 L 190.8 33.101 L 190.8 60.901 A 14.286 14.286 0 0 0 190.967 63.157 Q 191.159 64.357 191.573 65.329 A 6.76 6.76 0 0 0 192.35 66.701 A 5.017 5.017 0 0 0 195.632 68.686 A 7.727 7.727 0 0 0 197 68.801 A 12.963 12.963 0 0 0 199.953 68.438 Q 201.95 67.97 204.2 66.901 L 204.2 76.101 A 22.124 22.124 0 0 1 198.214 77.689 A 28.163 28.163 0 0 1 194.7 77.901 Q 187.6 77.901 183.8 73.601 Q 180.584 69.963 180.09 63.746 A 29.581 29.581 0 0 1 180 61.401 L 180 33.101 L 171.1 33.101 L 171.1 24.501 L 180 24.501 L 180 10.501 L 190.8 5.901 Z" id="3" vector-effect="non-scaling-stroke"/><path d="M 241.7 23.301 L 244.9 23.301 L 244.9 34.501 L 243.3 34.501 Q 234.7 34.501 229.5 39.901 L 229.5 76.701 L 218.7 76.701 L 218.7 36.101 L 216.5 24.501 L 227.3 24.501 L 228.9 32.701 A 60.032 60.032 0 0 1 230.91 29.977 Q 232.928 27.41 234.637 25.956 A 13.394 13.394 0 0 1 235.4 25.351 Q 238.2 23.301 241.7 23.301 Z" id="4" vector-effect="non-scaling-stroke"/><path d="M 259.1 24.501 L 269.9 24.501 L 269.9 76.701 L 259.1 76.701 L 259.1 24.501 Z M 261.332 13.816 A 7.251 7.251 0 0 0 264.5 14.501 Q 267.5 14.501 269.6 12.451 A 6.782 6.782 0 0 0 271.223 10.018 A 7.5 7.5 0 0 0 271.7 7.301 A 9.265 9.265 0 0 0 271.68 6.687 A 6.884 6.884 0 0 0 269.6 2.051 A 7.213 7.213 0 0 0 267.668 0.686 A 7.251 7.251 0 0 0 264.5 0.001 Q 261.5 0.001 259.4 2.051 A 6.717 6.717 0 0 0 257.7 4.727 A 7.958 7.958 0 0 0 257.3 7.301 A 9.009 9.009 0 0 0 257.302 7.494 A 6.862 6.862 0 0 0 259.4 12.451 A 7.213 7.213 0 0 0 261.332 13.816 Z" id="5" vector-effect="non-scaling-stroke"/><path d="M 325.7 27.801 L 325.7 37.701 L 325.3 37.701 A 24.868 24.868 0 0 0 310.542 32.806 A 30.549 30.549 0 0 0 310 32.801 A 15.909 15.909 0 0 0 305.486 33.407 A 11.726 11.726 0 0 0 299.3 37.701 Q 296.12 41.912 295.673 48.634 A 34.168 34.168 0 0 0 295.6 50.901 A 29.075 29.075 0 0 0 296.026 56.041 Q 296.54 58.895 297.671 61.174 A 14.921 14.921 0 0 0 299.25 63.701 Q 302.9 68.401 309.9 68.401 A 24.903 24.903 0 0 0 324.953 63.325 A 31.314 31.314 0 0 0 325.9 62.601 L 326.3 62.601 L 326.3 72.601 A 22.512 22.512 0 0 1 316.341 77.268 A 32.139 32.139 0 0 1 309.8 77.901 A 30.179 30.179 0 0 1 302.938 77.154 A 23.552 23.552 0 0 1 296.25 74.501 Q 290.5 71.101 287.4 64.951 Q 284.3 58.801 284.3 50.801 Q 284.3 42.701 287.45 36.501 Q 290.6 30.301 296.35 26.801 A 23.885 23.885 0 0 1 305.623 23.578 A 30.616 30.616 0 0 1 309.8 23.301 Q 317.712 23.301 323.133 26.176 A 19.471 19.471 0 0 1 325.7 27.801 Z" id="6" vector-effect="non-scaling-stroke"/><path d="M 354.8 5.901 L 354.8 24.501 L 368.1 24.501 L 368.1 33.101 L 354.8 33.101 L 354.8 60.901 A 14.286 14.286 0 0 0 354.967 63.157 Q 355.159 64.357 355.573 65.329 A 6.76 6.76 0 0 0 356.35 66.701 A 5.017 5.017 0 0 0 359.632 68.686 A 7.727 7.727 0 0 0 361 68.801 A 12.963 12.963 0 0 0 363.953 68.438 Q 365.95 67.97 368.2 66.901 L 368.2 76.101 A 22.124 22.124 0 0 1 362.214 77.689 A 28.163 28.163 0 0 1 358.7 77.901 Q 351.6 77.901 347.8 73.601 Q 344.584 69.963 344.09 63.746 A 29.581 29.581 0 0 1 344 61.401 L 344 33.101 L 335.1 33.101 L 335.1 24.501 L 344 24.501 L 344 10.501 L 354.8 5.901 Z" id="7" vector-effect="non-scaling-stroke"/><path d="M 426.5 50.601 L 426.5 54.001 L 389.8 54.001 A 22.095 22.095 0 0 0 390.905 58.897 A 15.418 15.418 0 0 0 394.65 64.851 A 13.522 13.522 0 0 0 401.379 68.376 A 19.866 19.866 0 0 0 405.6 68.801 Q 410.1 68.801 414.8 67.051 A 35.14 35.14 0 0 0 421.961 63.371 A 40.933 40.933 0 0 0 423.9 62.001 L 424.3 62.001 L 424.3 71.701 Q 416 77.901 405.5 77.901 A 32.581 32.581 0 0 1 398.368 77.154 A 25.225 25.225 0 0 1 391.4 74.501 Q 385.4 71.101 382.2 64.851 Q 379 58.601 379 50.401 A 36.106 36.106 0 0 1 379.784 42.72 A 28.823 28.823 0 0 1 381.95 36.351 Q 384.9 30.201 390.4 26.751 A 22.585 22.585 0 0 1 400.038 23.472 A 28.56 28.56 0 0 1 403.2 23.301 A 25.208 25.208 0 0 1 409.669 24.098 A 20.241 20.241 0 0 1 415.65 26.751 A 21.761 21.761 0 0 1 423.058 35.078 A 26.561 26.561 0 0 1 423.7 36.401 Q 426.5 42.601 426.5 50.601 Z M 389.9 46.201 L 415.4 46.201 A 28.165 28.165 0 0 0 414.584 42.001 Q 413.947 39.724 412.94 37.915 A 14.213 14.213 0 0 0 411.55 35.851 A 9.939 9.939 0 0 0 404.332 32.146 A 13.999 13.999 0 0 0 403.2 32.101 A 12.789 12.789 0 0 0 398.635 32.888 A 11.403 11.403 0 0 0 394.2 35.951 A 15.907 15.907 0 0 0 390.996 41.422 Q 390.237 43.567 389.91 46.12 A 27.682 27.682 0 0 0 389.9 46.201 Z" id="8" vector-effect="non-scaling-stroke"/><path d="M 489.2 76.701 L 478.9 76.701 L 477.3 69.801 A 24.994 24.994 0 0 1 468.128 76.152 A 24.871 24.871 0 0 1 459 77.801 A 19.57 19.57 0 0 1 452.227 76.68 A 16.783 16.783 0 0 1 444.25 70.451 Q 439.637 63.993 439.077 53.945 A 51.138 51.138 0 0 1 439 51.101 A 41.847 41.847 0 0 1 439.79 42.723 Q 440.841 37.578 443.293 33.587 A 23.921 23.921 0 0 1 445.25 30.851 A 20.375 20.375 0 0 1 458.674 23.567 A 29.482 29.482 0 0 1 462.7 23.301 Q 469.7 23.301 476.2 26.601 L 476.2 1.301 L 487 1.301 L 487 65.101 L 489.2 76.701 Z M 476.2 61.301 L 476.2 34.301 A 42.488 42.488 0 0 0 468.092 32.677 A 37.152 37.152 0 0 0 464.5 32.501 A 15.421 15.421 0 0 0 460.152 33.08 A 11.256 11.256 0 0 0 454.05 37.401 A 16.97 16.97 0 0 0 451.562 42.602 Q 450.5 46.198 450.5 50.901 Q 450.5 56.45 451.744 60.427 A 17.565 17.565 0 0 0 453.15 63.751 Q 455.499 67.962 460.167 68.44 A 12.105 12.105 0 0 0 461.4 68.501 Q 465.4 68.501 469 66.701 Q 472.375 65.014 475.75 61.744 A 39.786 39.786 0 0 0 476.2 61.301 Z" id="9" vector-effect="non-scaling-stroke"/><path d="M 550.9 17.001 L 518.8 17.001 L 518.8 38.001 L 544.3 38.001 L 544.3 47.401 L 518.8 47.401 L 518.8 76.701 L 508 76.701 L 508 7.101 L 550.9 7.101 L 550.9 17.001 Z" id="10" vector-effect="non-scaling-stroke"/><path d="M 564.9 72.301 L 564.9 61.301 A 67.462 67.462 0 0 0 573.943 65.498 Q 578.897 67.338 583.489 67.97 A 34.512 34.512 0 0 0 588.2 68.301 A 21.678 21.678 0 0 0 592.035 67.982 Q 595.42 67.373 597.75 65.601 A 8.621 8.621 0 0 0 601.245 59.345 A 11.524 11.524 0 0 0 601.3 58.201 A 9.776 9.776 0 0 0 600.953 55.537 A 7.69 7.69 0 0 0 599.35 52.551 A 13.877 13.877 0 0 0 595.347 49.395 A 16.427 16.427 0 0 0 594.45 48.951 Q 591.635 47.663 586.861 45.965 A 195.416 195.416 0 0 0 586.4 45.801 Q 582.033 44.256 578.794 42.801 A 52.769 52.769 0 0 1 575.9 41.401 A 20.001 20.001 0 0 1 569.274 35.749 A 23.146 23.146 0 0 1 569.05 35.451 Q 566.356 31.812 566.209 26.162 A 25.337 25.337 0 0 1 566.2 25.501 A 20.615 20.615 0 0 1 567.184 18.979 A 16.727 16.727 0 0 1 572.65 11.151 Q 578.439 6.44 587.892 5.957 A 43.267 43.267 0 0 1 590.1 5.901 Q 595.3 5.901 600.3 7.051 A 40.349 40.349 0 0 1 608.788 9.998 A 37.388 37.388 0 0 1 609.6 10.401 L 609.6 21.101 A 47.873 47.873 0 0 0 600.965 17.273 A 34.848 34.848 0 0 0 590.2 15.501 Q 586.082 15.501 583.172 16.572 A 11.53 11.53 0 0 0 580.65 17.851 A 8.181 8.181 0 0 0 578.416 20.05 Q 577.278 21.75 577.205 23.99 A 9.513 9.513 0 0 0 577.2 24.301 A 7.738 7.738 0 0 0 577.622 26.9 A 6.81 6.81 0 0 0 579 29.201 A 12.948 12.948 0 0 0 582.156 31.734 A 15.815 15.815 0 0 0 583.55 32.451 A 56.224 56.224 0 0 0 585.469 33.277 Q 587.645 34.169 590.666 35.247 A 193.796 193.796 0 0 0 591.1 35.401 A 127.973 127.973 0 0 1 595.593 37.1 Q 597.683 37.939 599.449 38.752 A 55.769 55.769 0 0 1 602 40.001 Q 606.2 42.201 609.25 46.351 A 15.516 15.516 0 0 1 611.78 51.892 Q 612.357 54.234 612.4 57.001 A 23.027 23.027 0 0 1 611.421 63.883 A 18.098 18.098 0 0 1 605.95 72.251 Q 599.576 77.834 589.053 77.901 A 40.231 40.231 0 0 1 588.8 77.901 A 48.526 48.526 0 0 1 581.06 77.255 A 59.065 59.065 0 0 1 576.8 76.401 Q 570.5 74.901 564.9 72.301 Z" id="11" vector-effect="non-scaling-stroke"/></g></svg>`;
  });

  // Filter source file names using a glob
  eleventyConfig.addCollection("docs", function (collection) {
    return collection.getFilteredByGlob(['site/docs/*.md']);
  });

  eleventyConfig.addPlugin(pluginSyntaxHighlight);
  eleventyConfig.addPlugin(eleventyNavigationPlugin);
  // eleventyConfig.addTransform("htmlmin", function (content, outputPath) {
  //   if (outputPath.endsWith(".html")) {
  //     let minified = htmlmin.minify(content, {
  //       useShortDoctype: true,
  //       removeComments: true,
  //       collapseWhitespace: true,
  //     });
  //     return minified;
  //   }
  //   return content;
  // });

  eleventyConfig.setLibrary(
    "md",
    require("markdown-it")({
      html: true,
      breaks: true,
      linkify: true,
    })
  .use(anchor, {
    permalink: anchor.permalink.headerLink(),
    permalinkClass: "direct-link",
    permalinkSymbol: "¶",
  })
  );

  return {
    pathPrefix: "/",
    passthroughFileCopy: true,
    dir: {
      data: `_data`,
      input: 'site',
      includes: `_includes`,
      layouts: `_includes`,
      output: '_site',
    },
  };
};
